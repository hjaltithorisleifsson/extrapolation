\chapter{Extrapolation of difference quotients}

\section{The algorithm}

Let \(a\in \R\), \(\varepsilon > 0\) and \(f:]a - \varepsilon, a + \varepsilon [ \rightarrow \R\) be differentiable at \(a\). We are interested in estimating \(f'(a)\). Assume that \(f\) is \(2k+1\) times differentiable at \(a\). Then by Taylor's theorem we have 
\begin{equation}\label{taylor}
f(a + h) = f(a) + f'(a)h + \frac{f''(a)}{2}h^2 + \cdots + \frac{f^{(2k)}(a)}{(2k)!}h^{2k} + \frac{f^{(2k+1)}(\xi)}{(2k+1)!}h^{2k+1}
\end{equation}
where \(a < \xi < a + h\). Now plug \(-h\) instead of \(h\) in (\ref{taylor}):
\begin{equation}\label{taylorm}
f(a-h) = f(a) - f'(a)h + \frac{f''(a)}{2}h^2 - \cdots + \frac{f^{(2k)}(a)}{(2k)!}h^{2k} -  \frac{f^{(2k+1)}(\eta)}{(2k+1)!}h^{2k+1}
\end{equation}
where \(a - h < \eta < a\). If we subtract (\ref{taylorm}) from (\ref{taylor}) and divide by \(2h\) we get:
\begin{equation}\label{middlestep}
f'(a) = D_f(h) + \frac{f'''(a)}{3!}h^2 + \cdots + \frac{f^{(2k-1)}(a)}{(2k-1)!}h^{2k-2} + \frac{f^{(2k+1)}(\xi) + f^{(2k+1)}(\eta)}{2\cdot (2k+1)!}h^{2k}
\end{equation}
where
\begin{equation}
D_f(h) \coloneqq \frac{f(a+h) - f(a-h)}{2h}
\end{equation}
is the {\it symmetric difference quotient} of \(f\) at \(a\). Note that \(\frac{1}{2}(f^{(2k+1)}(\xi) + f^{(2k+1)}(\eta))\) is in the image of \(f^{(2k+1)}\) so we can rewrite (\ref{middlestep}) as 
\begin{equation}\label{symmdiff}
f'(a) = D_f(h) + \frac{f'''(a)}{3!}h^2 + \cdots + \frac{f^{(2k-1)}(a)}{(2k-1)!}h^{2k-2} + \frac{f^{(2k+1)}(\zeta)}{(2k+1)!}h^{2k}
\end{equation}
where \(a-h < \zeta < a + h\). Formula (\ref{symmdiff}) tells us that the symmetric difference quotient method has asymptotic expansion in \(h^2\) of order \(2k-2\) if \(f\) is \(2k+1\) times differentiable. Thus we can use the following scheme to extrapolate the symmetric difference quotient method:

\begin{enumerate}
    \item \(D_{i1} \coloneqq D_f(h_i)\) for \(i = 1,\ldots,k\).
    \item \(D_{ij} \coloneqq D_{i,j-1} + \frac{D_{i,j-1} - D_{i-1,j-1}}{\left(\frac{h_{i-j+1}}{h_i}\right)^2 - 1}\) for \(2\leq j\leq i\).
\end{enumerate}

\section{Numerical experiments}

In this section we are going to extrapolate the symmetric difference quotient for approximating the derivative of a function at a given point. Let \(h > 0\) be some number, \(f: ]a-\varepsilon, a+\varepsilon[\rightarrow \R\) a function differentiable at \(a\) and \(n_1 < n_2 < \cdots\) a sequence of integers. Let \(h_i \coloneqq h/n_i\). Let \(D_{ij}\) be the extrapolation table that we get from extrapolating in \(h^2\) using the points \((h_1^2,D_f(h_1)),(h_2^2,D_f(h_2)),\ldots\), as we described in the first chapter. We let \(\varepsilon_i \coloneqq |X_{ii} - f'(a)|\). We want to analyze how \(\varepsilon_i\) as \(i\) increases and we also want to do similar efficiency analyzis as in the chapter on Romberg quadrature and check whether we have exponential convergence. We will do the computations with precision up to \(500\) significant digits and also using standard double precision arithmetic.\\

Now we will consider the results of the experiments.

\subsection{The exponential function}

We begin by considering the derivative of the exponential function at zero. 

\begin{figure}[H]
\centering
\begin{minipage}{0.45\textwidth}
\centering
\includegraphics[scale=0.45]{../results/diff_quot_plots/exp_0.png}
\end{minipage}
\begin{minipage}{0.45\textwidth}
\centering
\includegraphics[scale=0.45]{../results/diff_quot_plots/exp_0_hp.png}
\end{minipage}
\end{figure}

\begin{figure}[H]
\centering
\begin{minipage}{0.45\textwidth}
\centering
\includegraphics[scale=0.45]{../results/diff_quot_plots/exp_0_hp_trend.png}
\end{minipage}
\begin{minipage}{0.45\textwidth}
\centering
\includegraphics[scale=0.45]{../results/diff_quot_plots/exp_0_hp_romberg_stack.png}
\end{minipage}
\end{figure}

\begin{figure}[H]
\centering
\begin{minipage}{0.45\textwidth}
\centering
\includegraphics[scale=0.45]{../results/diff_quot_plots/exp_0_hp_bulirsch_stack.png}
\end{minipage}
\begin{minipage}{0.45\textwidth}
\centering
\includegraphics[scale=0.45]{../results/diff_quot_plots/exp_0_hp_harmonic_stack.png}
\end{minipage}
\end{figure}

\begin{table}[H]
    \centering
    \small
    \begin{tabular}{c|c||c|c|c|c|c|c}
Sequence & Plot & \(A\)-mean & \(A\)-var & \(c\)-mean & \(c\)-var & \(q\)-mean & \(q\)-var\\\hline
\rowcolor{green}
Romberg & lin-ln evals-error & \(0.03687\) & \(2.584\) & \(0.4004\) & \(0.004019\) & \(1.853\) & \(6.702\cdot 10^{-5}\) \\
\rowcolor{green}
Bulirsch & lin-ln evals-error & \(0.01953\) & \(3.508\) & \(0.4544\) & \(0.0119\) & \(1.716\) & \(0.0002258\) \\
\rowcolor{green}
Harmonic & lin-ln evals-error & \(1.122\cdot 10^5\) & \(3.293\) & \(1.732\) & \(0.007202\) & \(1.299\) & \(0.0002359\) \\
    \end{tabular}
    \label{tab:my_label}
\end{table}

In standard floating point arithmetic, we get down to machine level precision using any sequence. The Romberg sequence works best, then Bulirsch and then the harmonic. The model seems to fit well in all cases.

\subsection{Logarithm}

Now we will consider the dervative at zero of the function 
\[
g(x) \coloneqq \ln(x+1).
\]

\begin{figure}[H]
\centering
\begin{minipage}{0.45\textwidth}
\centering
\includegraphics[scale=0.45]{../results/diff_quot_plots/h_one.png}
\end{minipage}
\begin{minipage}{0.45\textwidth}
\centering
\includegraphics[scale=0.45]{../results/diff_quot_plots/h_one_hp.png}
\end{minipage}
\end{figure}

\begin{figure}[H]
\centering
\begin{minipage}{0.45\textwidth}
\centering
\includegraphics[scale=0.45]{../results/diff_quot_plots/h_one_hp_trend.png}
\end{minipage}
\begin{minipage}{0.45\textwidth}
\centering
\includegraphics[scale=0.45]{../results/diff_quot_plots/h_one_hp_romberg_stack.png}
\end{minipage}
\end{figure}

\begin{figure}[H]
\centering
\begin{minipage}{0.45\textwidth}
\centering
\includegraphics[scale=0.45]{../results/diff_quot_plots/h_one_hp_bulirsch_stack.png}
\end{minipage}
\begin{minipage}{0.45\textwidth}
\centering
\includegraphics[scale=0.45]{../results/diff_quot_plots/h_one_hp_harmonic_stack.png}
\end{minipage}
\end{figure}

\begin{table}[H]
    \centering
    \small
    \begin{tabular}{c|c||c|c|c|c|c|c}
Sequence & Plot & \(A\)-mean & \(A\)-var & \(c\)-mean & \(c\)-var & \(q\)-mean & \(q\)-var\\\hline
\rowcolor{green}
Romberg & lin-ln evals-error & \(0.009098\) & \(0.9823\) & \(0.2041\) & \(0.001354\) & \(1.967\) & \(2.052\cdot 10^{-5}\) \\
\rowcolor{green}
Bulirsch & lin-ln evals-error & \(0.001179\) & \(3.144\) & \(0.1757\) & \(0.01703\) & \(1.863\) & \(0.0002721\) \\
\rowcolor{green}
Harmonic & lin-ln evals-error & \(27.62\) & \(0.9622\) & \(1.126\) & \(0.003487\) & \(1.263\) & \(0.0001174\) \\
    \end{tabular}
    \label{tab:my_label}
\end{table}

We get down to machine level precision using any sequence, Romberg performes best, then Bulirsch and then the Harmonic one. The model fits well in all cases.

\subsection{Square root}

Now we shall consider the derivative at zero of the following function:
\[
h(x) \coloneqq \sqrt{1 + x}
\]

\begin{figure}[H]
\centering
\begin{minipage}{0.45\textwidth}
\centering
\includegraphics[scale=0.45]{../results/diff_quot_plots/sqrt_1.png}
\end{minipage}
\begin{minipage}{0.45\textwidth}
\centering
\includegraphics[scale=0.45]{../results/diff_quot_plots/sqrt_1_hp.png}
\end{minipage}
\end{figure}

\begin{figure}[H]
\centering
\begin{minipage}{0.45\textwidth}
\centering
\includegraphics[scale=0.45]{../results/diff_quot_plots/sqrt_1_hp_trend.png}
\end{minipage}
\begin{minipage}{0.45\textwidth}
\centering
\includegraphics[scale=0.45]{../results/diff_quot_plots/sqrt_1_hp_romberg_stack.png}
\end{minipage}
\end{figure}

\begin{figure}[H]
\centering
\begin{minipage}{0.45\textwidth}
\centering
\includegraphics[scale=0.45]{../results/diff_quot_plots/sqrt_1_hp_bulirsch_stack.png}
\end{minipage}
\begin{minipage}{0.45\textwidth}
\centering
\includegraphics[scale=0.45]{../results/diff_quot_plots/sqrt_1_hp_harmonic_stack.png}
\end{minipage}
\end{figure}

\begin{table}[H]
    \centering
    \small
    \begin{tabular}{c|c||c|c|c|c|c|c}
Sequence & Plot & \(A\)-mean & \(A\)-var & \(c\)-mean & \(c\)-var & \(q\)-mean & \(q\)-var\\\hline
\rowcolor{green}
Romberg & lin-ln evals-error & \(0.0008261\) & \(1.263\) & \(0.2064\) & \(0.001755\) & \(1.965\) & \(2.659\cdot 10^{-5}\) \\
\rowcolor{green}
Bulirsch & lin-ln evals-error & \(0.0001188\) & \(3.504\) & \(0.1792\) & \(0.01927\) & \(1.859\) & \(0.0003075\) \\
\rowcolor{red}
Harmonic & lin-ln evals-error & \(2.598\) & \(0.8154\) & \(1.155\) & \(0.002659\) & \(1.257\) & \(8.929\cdot 10^{-5}\) \\
    \end{tabular}
    \label{tab:my_label}
\end{table}

In standard double precision floating point arithmetic we get down to machine level precision using any sequence. The model fits well in all cases.

\subsection{Smooth but not analytic function}

Now we will consider the derivate at zero of the following function:
\[
r(x) \coloneqq \begin{cases}
e^{-1/x} & \text{if } x > 0\\
0 & \text{else}
\end{cases}
\]
which is smooth but not analytic.

\begin{figure}[H]
\centering
\begin{minipage}{0.45\textwidth}
\centering
\includegraphics[scale=0.45]{../results/diff_quot_plots/rho.png}
\end{minipage}
\begin{minipage}{0.45\textwidth}
\centering
\includegraphics[scale=0.45]{../results/diff_quot_plots/rho_hp.png}
\end{minipage}
\end{figure}

\begin{figure}[H]
\centering
\begin{minipage}{0.45\textwidth}
\centering
\includegraphics[scale=0.45]{../results/diff_quot_plots/rho_hp_trend.png}
\end{minipage}
\begin{minipage}{0.45\textwidth}
\centering
\includegraphics[scale=0.45]{../results/diff_quot_plots/rho_hp_romberg_stack.png}
\end{minipage}
\end{figure}

\begin{figure}[H]
\centering
\begin{minipage}{0.45\textwidth}
\centering
\includegraphics[scale=0.45]{../results/diff_quot_plots/rho_hp_bulirsch_stack.png}
\end{minipage}
\begin{minipage}{0.45\textwidth}
\centering
\includegraphics[scale=0.45]{../results/diff_quot_plots/rho_hp_harmonic_stack.png}
\end{minipage}
\end{figure}

\begin{table}[H]
    \centering
    \small
    \begin{tabular}{c|c||c|c|c|c|c|c}
Sequence & Plot & \(A\)-mean & \(A\)-var & \(c\)-mean & \(c\)-var & \(q\)-mean & \(q\)-var\\\hline
\rowcolor{green}
Romberg & lin-ln evals-error & \(7305\) & \(12.55\) & \(0.06014\) & \(0.02339\) & \(2.195\) & \(0.0002104\) \\
\rowcolor{green}
Bulirsch & lin-ln evals-error & \(0.2728\) & \(4.406\) & \(0.0178\) & \(0.03004\) & \(2.281\) & \(0.000316\) \\
\rowcolor{red}
Harmonic & lin-ln evals-error & \(287.5\) & \(4.85\) & \(0.818\) & \(0.4753\) & \(0.9831\) & \(0.02252\) \\
    \end{tabular}
    \label{tab:my_label}
\end{table}

Romberg performes best and the harmonic sequence worst.\\

The model seems to fit reasonably well for the Romberg and Bulirsch sequence but the fitting is not so nice for the harmonic sequence.

\subsection{Another smooth but not analytic function}

Now we will consider the derivative at zero of the following function:
\[
i(x)\coloneqq \begin{cases}
xe^{-1/x^2} & \text{if } x \neq 0\\
0 & \text{else}
\end{cases}
\]
which is smooth but not analytic.

\begin{figure}[H]
\centering
\begin{minipage}{0.45\textwidth}
\centering
\includegraphics[scale=0.45]{../results/diff_quot_plots/xemxm2.png}
\end{minipage}
\begin{minipage}{0.45\textwidth}
\centering
\includegraphics[scale=0.45]{../results/diff_quot_plots/xemxm2_hp.png}
\end{minipage}
\end{figure}

\begin{figure}[H]
\centering
\begin{minipage}{0.45\textwidth}
\centering
\includegraphics[scale=0.45]{../results/diff_quot_plots/xemxm2_hp_trend.png}
\end{minipage}
\begin{minipage}{0.45\textwidth}
\centering
\includegraphics[scale=0.45]{../results/diff_quot_plots/xemxm2_hp_romberg_stack.png}
\end{minipage}
\end{figure}

\begin{figure}[H]
\centering
\begin{minipage}{0.45\textwidth}
\centering
\includegraphics[scale=0.45]{../results/diff_quot_plots/xemxm2_hp_bulirsch_stack.png}
\end{minipage}
\begin{minipage}{0.45\textwidth}
\centering
\includegraphics[scale=0.45]{../results/diff_quot_plots/xemxm2_hp_harmonic_stack.png}
\end{minipage}
\end{figure}

\begin{table}[H]
    \centering
    \small
    \begin{tabular}{c|c||c|c|c|c|c|c}
Sequence & Plot & \(A\)-mean & \(A\)-var & \(c\)-mean & \(c\)-var & \(q\)-mean & \(q\)-var\\\hline
\rowcolor{green}
Romberg & lin-ln evals-error & \(0.009202\) & \(1.693\) & \(0.1182\) & \(0.00696\) & \(2.073\) & \(9.612\cdot 10^{-5}\) \\
\rowcolor{yellow}
Bulirsch & lin-ln evals-error & \(0.4381\) & \(5.98\) & \(0.07965\) & \(0.09556\) & \(2.015\) & \(0.001606\) \\
\rowcolor{red}
Harmonic & lin-ln evals-error & \(2.061\cdot 10^{16}\) & \(12.84\) & \(1.483\) & \(1.04\) & \(1.216\) & \(0.03736\) \\
    \end{tabular}
    \label{tab:my_label}
\end{table}

Here Romberg performes best and the harmonic sequence worst.\\

We seem to have nice fit for the Romberg sequence, moderately good for the Bulirsch sequence but not so good for the harmonic sequence.

\subsection{Only once differentiable function}

Finally we will consider the derivate at zero of the following function which is only once differentiable at that point:
\[
j(x)\coloneqq \begin{cases}
x^2\sin\frac{1}{x} & \text{if } x \neq 0\\
0 & \text{else}
\end{cases}.
\]

\begin{figure}[H]
\centering
\begin{minipage}{0.45\textwidth}
\centering
\includegraphics[scale=0.45]{../results/diff_quot_plots/xsin.png}
\end{minipage}
\begin{minipage}{0.45\textwidth}
\centering
\includegraphics[scale=0.45]{../results/diff_quot_plots/xsin_hp.png}
\end{minipage}
\end{figure}

\begin{figure}[H]
\centering
\begin{minipage}{0.45\textwidth}
\centering
\includegraphics[scale=0.45]{../results/diff_quot_plots/xsin_hp_trend.png}
\end{minipage}
\end{figure}

\begin{table}[H]
    \centering
    \small
    \small
    \begin{tabular}{c|c||c|c|c|c|c|c}
Sequence & Plot & \(A\)-mean & \(A\)-var & \(c\)-mean & \(c\)-var & \(q\)-mean & \(q\)-var\\\hline
\rowcolor{red}
Romberg & lin-ln evals-error & \(1.99\cdot 10^{27}\) & \(13\) & \(6.139\) & \(3.832\) & \(0.8069\) & \(0.397\) \\
\rowcolor{red}
Bulirsch & lin-ln evals-error & \(.\) & \(.\) & \(2316\) & \(4.918\) & \(1.24\) & \(0.4409\) \\
\rowcolor{red}
Harmonic & lin-ln evals-error & \(0.3968\) & \(1.653\) & \(-0.3656\) & \(6.72\) & \(1.307\) & \(0.09291\) \\
    \end{tabular}
    \label{tab:my_label}
\end{table}

Here the model simply does not fit. Note that we do not have the asymptotic expansion for the derivate here, since the function is only once differentiable.\\

The parameters from the fitting are:

\begin{table}[H]
    \centering
    \begin{tabular}{c|c||c|c|c}
        Derivative & Sequence & \(b\) & \(c\) & \(q\) \\\hline\hline
$d/dx|_{x=0}r(x)$ & Romberg & \(-0.99982\) & \(0.060703\) & \(2.189\) \\
$d/dx|_{x=0}r(x)$ & Bulirsch & \(-3.3384\) & \(0.017962\) & \(2.2735\) \\
$d/dx|_{x=0}r(x)$ & Harmonic & \(-1.8705\) & \(0.42555\) & \(1.0695\) \\
$d/dx|_{x=0}xe^{-1/x^2}$. $h=1/2$ & Romberg & \(-4.0202\) & \(0.12391\) & \(2.0616\) \\
$d/dx|_{x=0}xe^{-1/x^2}$. $h=1/2$ & Bulirsch & \(-5.4352\) & \(0.089335\) & \(1.9741\) \\
$d/dx|_{x=0}xe^{-1/x^2}$. $h=1/2$ & Harmonic & \(-0.55045\) & \(0.81216\) & \(1.2174\) \\
$d/dx|_{x=0}\sin x$. $h=1/2$ & Romberg & \(-5.3663\) & \(0.51067\) & \(1.8066\) \\
$d/dx|_{x=0}\sin x$. $h=1/2$ & Bulirsch & \(-5.1899\) & \(0.64124\) & \(1.651\) \\
$d/dx|_{x=0}\sin x$. $h=1/2$ & Harmonic & \(3.912\) & \(1.9876\) & \(1.2878\) \\
$d/dx|_{x=0} \ln(x + 1)$. $h=1/2$ & Romberg & \(-3.4927\) & \(0.20942\) & \(1.9619\) \\
$d/dx|_{x=0} \ln(x + 1)$. $h=1/2$ & Bulirsch & \(-5.1421\) & \(0.19126\) & \(1.8443\) \\
$d/dx|_{x=0} \ln(x + 1)$. $h=1/2$ & Harmonic & \(1.0555\) & \(1.0494\) & \(1.2768\) \\
$d/dx|_{x=0} x^2 \sin(1/x)$. $h=1$ & Romberg & \(1.5925\) & \(0.59863\) & \(0.88054\) \\
$d/dx|_{x=0} x^2 \sin(1/x)$. $h=1$ & Bulirsch & \(0.33976\) & \(0.083956\) & \(1.1751\) \\
$d/dx|_{x=0} x^2 \sin(1/x)$. $h=1$ & Harmonic & \(-1.436\) & \(-0.034733\) & \(1.4204\) \\
$d/dx|_{x=0} \sqrt{x + 1}$. $h=1/2$ & Romberg & \(-5.7063\) & \(0.21299\) & \(1.9582\) \\
$d/dx|_{x=0} \sqrt{x + 1}$. $h=1/2$ & Bulirsch & \(-7.315\) & \(0.19691\) & \(1.8379\) \\
$d/dx|_{x=0} \sqrt{x + 1}$. $h=1/2$ & Harmonic & \(-0.86323\) & \(1.0951\) & \(1.2682\) \\
$d/dx|_{x=0}e^x$ & Romberg & \(-2.408\) & \(0.41106\) & \(1.8479\) \\
$d/dx|_{x=0}e^x$ & Bulirsch & \(-2.9068\) & \(0.48137\) & \(1.703\) \\
$d/dx|_{x=0}e^x$ & Harmonic & \(4.7175\) & \(1.5509\) & \(1.3212\) \\
    \end{tabular}
    \caption{Optimal parameters by test case}
    \label{tab:my_label}
\end{table}

Excluding the computation of \(d/dx|_{x=0}x^2\sin 1/x\), the model fits exceptionally. We always get fast convergence except when computing \(d/dx|_{x=0}x\sin 1/x\) and extrapolation with the harmonic sequence. Excluding this case, we always get almost down to machine level precision when using double precision arithmetic, using any extrapolation sequence. It is worth noting that \(x\sin 1/x\) is only once differentiable at \(0\) so we do not have the asymptotic expansion for its derivative at \(0\). The Romberg sequence performes best and the harmonic sequence worst, in all cases.\\